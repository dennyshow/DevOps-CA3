trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  javaVersion: '17'

stages:
- stage: Build
  jobs:
  - job: BuildJob
    steps:
    - task: JavaToolInstaller@0
      inputs:
        versionSpec: '$(javaVersion)'
        jdkArchitectureOption: 'x64'
        jdkSourceOption: 'PreInstalled'
    
    - task: Gradle@3
      inputs:
        workingDirectory: ''
        gradleWrapperFile: 'gradlew'
        gradleOptions: '-Xmx3072m'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '$(javaVersion)'
        jdkArchitectureOption: 'x64'
        publishJUnitResults: true
        testResultsFiles: '**/TEST-*.xml'
        tasks: 'clean build'

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'build-outputs'

- stage: Test
  displayName: 'Test Stage'
  dependsOn: Build
  jobs:
  - job: RunSeleniumTests
    displayName: 'Run Selenium Tests'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: Checkout@1

    - task: DownloadBuildArtifacts@0
      inputs:
        buildType: 'current'
        artifactName: 'build-outputs'
        downloadPath: '$(System.DefaultWorkingDirectory)'

    - script: |
        sudo apt-get update
        sudo apt-get install -y \
          google-chrome-stable \
          libasound2 \
          libatk1.0-0 \
          libcups2 \
          libdbus-1-3 \
          libgconf-2-4 \
          libgtk-3-0 \
          libnspr4 \
          libnss3 \
          libpango-1.0-0 \
          libx11-xcb1 \
          libxcomposite1 \
          libxcursor1 \
          libxdamage1 \
          libxi6 \
          libxrandr2 \
          xdg-utils \
          fonts-liberation
      displayName: 'Install Chrome and Dependencies'

    - script: |
        CHROME_DRIVER_VERSION=$(google-chrome --version | grep -oP '\d+\.\d+\.\d+' | head -1)
        wget -N https://chromedriver.storage.googleapis.com/${CHROME_DRIVER_VERSION}/chromedriver_linux64.zip
        unzip chromedriver_linux64.zip -d /usr/local/bin/
        chmod +x /usr/local/bin/chromedriver
      displayName: 'Install ChromeDriver'

    - script: |
        java -jar $(System.DefaultWorkingDirectory)/build/libs/*.jar &
        echo "Waiting for the application to start..."
        sleep 15
      displayName: 'Start Application'

    - task: Gradle@3
      inputs:
        workingDirectory: ''
        gradleWrapperFile: 'gradlew'
        gradleOptions: '-Xmx3072m'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '17'
        jdkArchitectureOption: 'x64'
        publishJUnitResults: true
        testResultsFiles: '**/TEST-*.xml'
        tasks: 'clean test'
